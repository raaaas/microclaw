name: Nightly Stability

on:
  schedule:
    - cron: '17 3 * * *'
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always
  RUSTFLAGS: -Dwarnings

permissions:
  contents: read
  issues: write

concurrency:
  group: nightly-stability
  cancel-in-progress: false

jobs:
  nightly-stability:
    name: Nightly Stability Gate
    runs-on: ubuntu-latest
    timeout-minutes: 45
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy
      - uses: Swatinem/rust-cache@v2
      - name: Run nightly stability gate
        id: gate
        run: scripts/ci/nightly_stability.sh
        continue-on-error: true
      - name: Create or update failure issue
        if: steps.gate.outcome == 'failure'
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const label = "nightly-stability";
            const runUrl = `${context.serverUrl}/${owner}/${repo}/actions/runs/${context.runId}`;
            const title = "Nightly Stability Gate failing";
            const body = [
              "Nightly stability gate failed.",
              "",
              `- Workflow run: ${runUrl}`,
              `- Commit: ${context.sha}`,
              `- Trigger: ${context.eventName}`,
              "",
              "Please inspect logs and fix regressions in smoke tests or metrics contract assertions."
            ].join("\\n");

            try {
              await github.rest.issues.createLabel({
                owner,
                repo,
                name: label,
                color: "B60205",
                description: "Nightly stability regression tracking"
              });
            } catch (e) {
              if (e.status !== 422) throw e;
            }

            const { data } = await github.rest.search.issuesAndPullRequests({
              q: `repo:${owner}/${repo} is:issue is:open in:title "${title}" label:${label}`,
              per_page: 1
            });

            if (data.items.length > 0) {
              const issue = data.items[0];
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: issue.number,
                body
              });
            } else {
              await github.rest.issues.create({
                owner,
                repo,
                title,
                body,
                labels: [label]
              });
            }
      - name: Fail workflow when gate fails
        if: steps.gate.outcome == 'failure'
        run: exit 1
